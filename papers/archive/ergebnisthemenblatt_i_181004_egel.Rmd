---
title: |
  | Kurzberichte NOVANIMAL
  | Transdisziplin?res Experiment in zwei Hochschulmensen: Auswertungen der Men?-Verk?ufe
author: "Gian-Andrea Egeler, Priska Baur"
date: "`r format(Sys.Date(), '%B %Y')`"
output:
  word_document: default
  pdf_document:
    fig_caption: yes
header-includes:
- \usepackage{fancyhdr}
- \usepackage{setspace}
- \onehalfspacing
- \usepackage{float}
- \usepackage{graphicx}
- \usepackage[font=small,labelfont=bf]{caption}
- \usepackage{apacite}
- \bibliographystyle{apacite}
- \bibliography{biblio_181004.bib}
lang: de-DE
geometry: margin = 1.2in
fontsize: 12pt
---

<!-- check papaja package for papers!! -->

```{r setup, include=FALSE, message=F, warning=F}
knitr::opts_chunk$set(echo = F, warning = F, error = F, message = F, fig.align='center', fig.pos ='H')

library(apa) # for reporting apa style for e.g. chisquare test
library(dplyr)
library(tidyr)
library(lubridate)
library(stringr)
library(ggplot2)

#rmarkdown::render("papers/ergebnisthemenblatt_i_181004_egel.Rmd", output_format = "pdf_document", encoding="LATIN1") # here is the code to knitr the rmd file in the environment (takes data already load, otherwise many errors occur)

#xaringan::inf_mr() # LiveReload: a technology that enables you to live preview the output as soon as you save the source document, and you do not need to hit the Knit button => is not working on that machine (due to encoding)

# attention function is dark causes problems, run that first into the environment
# parindent causes some errors dont know the reason
```


###	1. Lead / Teaser

Die zentrale Bedeutung tierischer Produkte spiegelt sich im Angebot der Gastronomie. Im Jahr 2015 sind Fleischgerichte (20.3%) mit den entsprechenden Beilagen (30.8%) im Zusammenhang der Ausser-Haus-Verpflegung die meistkonsumierten Speisen in der Schweiz [@gastrosuisse_branchenspiegel_2016]. Gem?ss der ersten in den Jahren 2014/2015 durchgef?hrten nationalen Ern?hrungserhebung menuCH essen 70 % der Bev?lkerung zwischen 18 und 75 Jahren am Mittag ausw?rts [@bochud_anthropometric_2017]. Daher r?ckt die Gemeinschaftsgastronomie als zentraler Akteur einer innovativen und nachhaltigen Ern?hrungswirtschaft ins Blickfeld. Welche Innovationen in der Gemeinschaftsgastronomie k?nnten dazu beitragen, den Pro-Kopf-Verbrauch an tierischen Nahrungsmitteln zu senken?

###	2. Forschungsfragen und Ziele

Die ?bergeordnete Forschungsfrage dieses Arbeitspackets WPIII.1 war es, die G?ste in Mensen dazu zu bewegen, h?ufiger ressourcenschonende vegetarische^[vegetarisch = ovo-lakto-vegetarisch (inkl. Eier und Milch)] oder vegane^[vegan = ausschliesslich pflanzliche Zustaten] Gerichte zu w?hlen. Die daraus abgeleiteten Forschungsfragen sind wie das Men?-Angebot und die Men?-Beschriftung die Men?-Wahl der Mensabesucher beeinflusst?

\newpage

###	3. Theoretischer Hintergrund und Methoden 

Zusammen mit den Praxispartnern, einem Catering Unternehmen und dem Facility Management einer Hochschule, wurde ein Experiment vorbereitet, das als Pilotversuch in zwei Hochschulmensen durchgef?hrt wird. Konkret wird untersucht, wie die G?ste auf ein ver?ndertes Men?-Angebot mit einem h?heren Anteil an ressourcenschonenden vegetarischen oder veganen Gerichten reagieren. 
\par
Das Experiment findet im Herbstsemester (HS) 2017 w?hrend 12 Wochen statt und bestand aus zwei Mensazyklen ? 6 Wochen (siehe Abbildung \ref{fig:fig1}). In den 6 Referenz- bzw. Basiswochen wurden zwei fleisch- oder fischhaltige Gerichte und ein vegetarisches Gericht angeboten. In den 6 Interventionswochen wurde das Verh?ltnis umgekehrt und es wurden ein veganes, ein vegetarisches und ein fleisch- oder fischhaltiges Gericht angeboten. Beim veganen Angebot wurde zwischen eigenst?ndige authenische Gerichte^[Gerichte, welche ausschliesslich aus pflanzlichen Zutaten bestehen z. B. Linsen-Dal] und vegane Gerichte mit Fleischsubstituten^[Gerichte, welche neben pflanzlichen Zutaten auch noch Fleischsubstitute beinhalteten z. B. Tofu-Burger] unterschieden. Basis- und Interventionsangebote wechselten w?chentlich ab. W?hrend der gesamten 12 Wochen konnten die G?ste jeweils auf ein Buffet ausweichen und ihre Mahlzeit aus warmen und kalten Komponenten selber zusammenstellen. 
\par
Die nachfolgenden Analysen und Ergebnisse basieren auf Daten aus den Kassensystemen des Catering Unternehmens. F?r die Analysen sind mehr als 26'000 Men?-Verk?ufe resp. Transaktionen w?hrend der Mittagszeit ber?cksichtigt worden. Alle Analysen wurden mit dem Statistikprogramm R (`r str_sub(version$version.string, start = 3)`) gerechnet.

```{r, fig.cap="\\label{fig:fig1} Die Abbildung zeigt das Versuchsdesign der ersten 6 Experimentwochen (Kalenderwochen 40 bis 45).", out.width = '100%', dpi=200}
knitr::include_graphics("design_eng_experiment_ohne datum_180426_03egel.png")
```

###	4. Ergebnisse
#### 4.1 Verkaufszahlen ?ber alle 12 Wochen

Im Vergleich zu den vergangenen HS 2015 und 2016 wuchs das vegetarische und vegane Angebot im HS 2017 von `r ((30*.2)+30)/90*100` Prozent auf knapp 47 Prozent, wobei das Hot and Cold-Buffet nicht als vegetarisches Angebot mitgez?hlt wurde. 
\par
Die totalen Verkaufszahlen des HS 2017 haben sich im Vergleich zu den zwei HS 2015 und 2016 nur marginal ver?ndert. Die Abbildung \ref{fig:fig2} zeigt alle verkauften Gerichten nach Men?-Inhalt, welche w?hrend des Experiments verkauft wurden.

```{r fig.cap="\\label{fig:fig2} Die Abbildung zeigt alle verkauften Gerichten (\\textit{N} = 26'234) aufgeteilt nach den f?nf Men?-Inhalten ?ber die 12 Wochen.", fig.height=18, fig.width=25, dpi=200, out.width='100%'}

# to load data first execture 04_load_data
#prepare data for plot: aggregated data => locals are included
df_ <- group_by(df_agg, condit ,week, label_content )%>% summarise(tot_sold=n())

df_ <- df_ %>% 
    group_by(week,condit) %>% # give in variable, you want to calculate percentage
    mutate(pct=(tot_sold/sum(tot_sold)))

# ranem NA to unknown
df_$label_content <- ifelse(is.na(df_$label_content),"Unknown",df_$label_content)

# annotation for selling per week
text <- group_by(df_agg, week) %>% summarise(tot = n()) %>%
    mutate(label = "italic(n)") %>%
    mutate(label2 = paste(label, tot, sep="=="))

# define x-lab for plot
df_$xlab <- paste(df_$week, df_$condit, sep = "\n")


## check if the background color is dark or not
# see mytheme for function
# my colors for the plot
ColsPerCat=c("Unknown" = "black","Pflanzlich" = "grey90", "Pflanzlich+" = "#80ccff", "Vegetarisch" = "#c5b87c", "Fleisch" = "#fad60d","Hot and Cold"="#4c4848")
 
# detects dark color: for labelling the bars
isDark <- function(color) {
    (sum(grDevices::col2rgb(color) *c(299, 587,114))/1000 < 123)
}

df_$label_color <- as.factor(sapply(unlist(ColsPerCat)[df_$label_content], # takes every label and their belonged color
                                    function(color) { if (isDark(color)) 'white' else 'black' })) # check if color is dark, than give back "white" else "black"

# barplot
p <- ggplot(df_, aes(y = pct,x = as.factor(xlab), fill = factor(label_content, c("Unknown", "Pflanzlich", "Pflanzlich+", "Vegetarisch", "Fleisch", "Hot and Cold")), color = label_color)) + 
    geom_bar(stat = "identity", position = "fill", color = NA, width = .6) + # set color NA otherwise error occurs
    xlab("Herbstsemesterwochen (Kalenderwochen 40 bis 51)") +
    # xlab(cat('"winter semester weeks (Basis: "','meat','" week, Intervention: "','vegetarian','" week"'))+
    ylab("\nVerkaufte Men?s in Prozent")+
    guides(fill = guide_legend("Men?-Inhalt\n"),
           color = F)+
    scale_y_continuous(labels=scales::percent)+
    scale_fill_manual(values = ColsPerCat,
                      breaks = attributes(ColsPerCat)$name,
                      labels = c("Unbekannt","vegan (Fleischersatz)", "vegan (authentisch)", "ovo-lakto-vegetarisch", "Fleisch oder Fisch", "Hot and Cold"))+
    scale_color_manual(values = levels(df_$label_color))+
    geom_text(aes(label=ifelse(pct*100>1.5,paste0(round(pct*100, digits=0),"%"),"")),size = 8, position = position_stack(vjust = 0.5))+ # omit 0% with ifelse()
    annotate( 
        "text",x = 1:12, y = 1.03, label = text$label2,parse=T, size=9) + # why so big differences to the first version
    mytheme

p + labs(caption = "Daten: Kassendaten SV Schweiz (2017)")

```

```{r, results="hide", comment=F, fig.show="hide"}
# test if week sellings statistically differ
# j?rgen dengler said: if the variances are not 4 times bigger than the other variance => go with the parametric statistics otherwise do some checking for the non-parametric statistics (they have also requirements)

sell_dat <- df_agg %>%
    mutate(day=wday(date, label = T)) %>% 
    group_by(semwk, condit) %>%
    summarise(tot_sold=n())

ao1=(aov(sell_dat$tot_sold ~ sell_dat$condit)) 
t.test(sell_dat$tot_sold ~ sell_dat$condit) # same as aov
summary(ao1)

# test if meal content differ statistically
sell_dat <- df_agg %>%
    mutate(label_content2 = str_replace_all(.$label_content, "Pflanzlich\\+", "Vegan")) %>% # change name 
    mutate(label_content2 = str_replace(.$label_content2, "Pflanzlich", "Vegan")) %>% # change name
    group_by(semwk, condit, label_content2) %>%
    summarise(tot_sold=n()) %>%
    na.omit()  # omit NA, another better way is drop_na()
    #filter(!label_content2 == "Hot and Cold")

ao2 <- aov(sell_dat$tot_sold ~ sell_dat$label_content2 * sell_dat$condit) # anova only with interaction between label_content and condit (tried with log10, however dont look good at al on the model diagnostics)
library(ggfortify)
autoplot(ao2) # dont look very nice, however i would accept it :)
summary.lm(ao2) # display anova
TukeyHSD(ao2) #post-hoc test


# otherwise Welch test would be appropriate as well (one.test())

```

Der Abbildung \ref{fig:fig2} ist zu entnehmen, dass die w?chentlichen Verkaufszahlen im HS 2017 sich statistisch nicht unterscheiden (*F*(1,10) = `r round(summary(ao1)[[1]][["F value"]][1], digits = 3)`, *p* < .001). Des Weiteren gab es Unterschiede in den Verkaufszahlen zwischen den Basis- und Interventionswochen (*F*(7, 39) = `r round(summary(ao2)[[1]][["F value"]][1], digits = 2)`, *p* < .001). Neben den schwankenden verkaufszahlen der Fleischgerichte, f?llt es auf, dass vegane authentische Gerichte deutlich besser verkauft wurden als vegan fleischsubstitituierte Gerichte.   


#### 4.2 Men?-Optionen

Von insgesamt 93 verschiedenen Gerichten, welche ?ber zwei Mensazyklen^[ein Zyklus besteht aus 6 Wochen, danach wiederholen sich die Gerichten] verteilt angeboten wurden, enthielten `r round((45/93)*100, digits = 0)` Prozent (*n* = 45) der Gerichte Fleisch. Ein Drittel (*n* = 31) der Gerichte wurde vegetarisch und die restlichen `r round((16/93)*100, digits = 0)` Prozent (*n* = 16) ausschliesslich pflanzlich angeboten.
\par
Neunzig verschiedenen Mahlzeiten wurden pro Mensa und Mensazyklus auf drei Men?-Linien (Favorite, Kitchen und World) angeboten. Wird das gesamte Angebot auf beide Mensen und ?ber alle Tage addiert, ergibt das ein geplantes Angebot von 360 Gerichten^[90 Gerichte x 2 Mensazyklen x 2 Mensen]. Aus betrieblichen Gr?nden kam es beim Catering Unternehmen des ?fteren zu Zusatzangeboten, welche das geplante Angebot zus?tzlich vergr?sserte. In den 12 Wochen wurden zu den total geplanten 360 Gerichten noch 120 Gerichten zus?tzlich angeboten (siehe Abbildung \ref{fig:fig3}).

```{r, results='hide'}
# show aggregated total meal offer (N = 480 or 596 without NA's)
# exclude hot and cold
t0 <- filter(info_orig, !grepl("Hot and Cold", info_orig$label_content)) %>% group_by(label_content, condit) %>% summarise(tot = n()) %>% ungroup() %>% group_by(condit) %>% mutate(pct = tot/sum(tot))  

# show aggregated offer without locals (N = 360)
p0 <- filter(info_orig, !grepl("Local ", info_orig$article_description) & !grepl("Hot and Cold", info_orig$label_content)) %>% group_by(label_content, condit) %>% summarise(tot = n()) %>% ungroup() %>% group_by(condit) %>% mutate(pct = tot/sum(tot))

# chi-square to compare if the two meals offer (total meal and planed meal offer) differs
# drop unknown meal offers for chi_square test
t <- drop_na(t0) %>% group_by(label_content) %>% summarise(tot = sum(tot)) %>% mutate(pct = tot/sum(tot)) 
p <- group_by(p0, label_content) %>% summarise(tot = sum(tot)) %>% mutate(pct = tot/sum(tot))

tp <- tibble(label = unique(t$label_content), t$tot, p$tot)

# chisquare not significant
chi_s <- chisq.test(t$tot, p = p$pct) # test against expected probability (= which is the planed meal offer)
fisher.test(tp[ ,2:3]) # exact p-value via fisher.test

# chi-square to compare if the two meals offer differ accodring condition 
# start code from the start again
tp0 <- drop_na(t0) %>% select(-pct) %>% bind_cols(., p0[c("tot")]) %>% rename( real_offer = tot, planed_offer = tot1)

# basis
tp1 <- filter(tp0, condit == "Basis") %>% mutate(pct_exp = planed_offer / sum(planed_offer), 
                                               pct_real = real_offer / sum(real_offer))

chi_s2 <- chisq.test(tp1$real_offer, p = tp1$pct_exp) # check if expected frequencies are over 5
fisher.test(tp1[ ,3:4]) # for exact p-value, it differs strongly form the p-value from chi-square => is also another test with two factors in comparison of the chi-square with only one factor!

#interventionswochen
tp1 <- filter(tp0, condit == "Intervention") %>% mutate(pct_exp = planed_offer / sum(planed_offer), pct_real = real_offer / sum(real_offer))
chi_s3 <- chisq.test(tp1$real_offer, p = tp1$pct_exp) # check if expected frequencies are over 5
fisher.test(tp1[ ,3:4]) # for exact p-value, it differs strongly form the p-value from 

```

```{r, fig.cap="\\label{fig:fig3} Die Abbildung zeigt das geplante (\\textit{n} = 480) und angebotene Angebot (\\textit{n} = 600) f?r ein ganzes Herbstsemester (60 Tage) und zwei Hochschulmensen nach den f?nf Men?-Inhalten.", out.width='100%' , fig.height=10, fig.width=14}
# plot real and planed offer
##prepare data
# target for 2015 and 2016 and 2017 for both canteens (per canteen 120 meals) and for both cycles: 480 melas in total
# per canten and cycle: meat:54 (30 + 30*.8), vegetarian:36, hot and cold: 30

df_plan_56 <- tibble(year = rep(2015, times=360, each=1),
                     label_content = rep(c("Fleisch","Vegetarisch"), times=c((120 + 120*.8),(120 + 120*.2))),
                     offer = "Geplant")

# plan for intervention:: per canten and cycle: meat: 45, vegetarian: 30, hot and cold: 30, vegan: 7, vegan+: 8
# plan for basis:: per canteen and cycle: meat: 60, vegetarian: 30, hot and cold: 30

df_plan_7 <- tibble(year = rep(2017, times=360),
                    label_content = rep(c("Fleisch","Vegetarisch","Pflanzlich","Pflanzlich+"), times=c(180,120,28,32)),
                    offer= "Geplant")

# Actual: Locals are included
# use documentation for that (not selling data)
# exclude hot and cold (only using filter() is deleting missing cases!)
df_actual_7 <- info_orig %>% filter(!grepl("Hot and Cold", info_orig$label_content)) %>% mutate(offer = "Angeboten", year = year(date)) %>% dplyr::select(year,label_content,offer)
    
# Merge data frames
df_t= bind_rows(df_plan_56, df_plan_7, df_actual_7)

# Group data frame
df_ <- df_t %>%
    group_by(year,label_content, offer) %>%
    summarise(tot=n()) %>%
    ungroup() # otherwise dataframe is still grouped

# define some variables
df_$xlab <- paste(df_$year,df_$offer, sep = "\n")
df_$xlab <- str_replace(df_$xlab,"2015\nGeplant","2015 - 2016\nGeplant")
df_$label_content <- ifelse(is.na(df_$label_content),"Unbekannt",df_$label_content)

# define text for annotation
text <- group_by(df_, year, offer) %>%
    summarise(tot=sum(tot)) %>%
    mutate(label = "n") %>%
    mutate(label2=paste(label,tot,sep=" = "))

## check if the background color is dark or not
# see mytheme for function
# my colors for the plot
ColsPerCat=c("Unbekannt" = "black","Pflanzlich"="grey90", "Pflanzlich+"="#80ccff", "Vegetarisch" = "#c5b87c", "Fleisch" = "#fad60d","Hot and Cold"="#4c4848")

df_$label_color <- as.factor(sapply(unlist(ColsPerCat)[df_$label_content], # takes every label and their belonged color
                                     function(color) { if (isDark(color)) 'white' else 'black' })) # check if color is dark, than give back "white" else "black"


#plot in de
ggplot(df_, aes(y=tot,x=xlab, fill=factor(label_content,levels=c("Unbekannt","Pflanzlich","Pflanzlich+","Vegetarisch","Fleisch","Hot and Cold")), color=label_color)) +
    geom_bar(stat="identity", position = "stack", color=NA, width = .5) +
    xlab("") + #"\nGeplante und angebotene Men?-Optionen w?hrend Herbstsemester (Kalenderwochen 40 bis 51)"
    ylab("Geplante und angebotene Men?-Optionen")+ # title: 
    #     ggtitle("note: locals are not included
    #          selling time between 9 a.m. until 3 p.m.
    #          locals meals in total: 2602")+
    guides(fill= guide_legend("Men?-Inhalt"),
           color=F)+
    # scale_y_continuous(labels = scales::percent)+
    scale_fill_manual(values = ColsPerCat,
                      breaks = attributes(ColsPerCat)$name,
                      labels = c("Unbekannt","Vegan (Fleischsubstitut)","Vegan (authentisch)","Vegetarisch","Fleisch oder Fisch", "Hot and Cold"))+
    scale_color_manual(values = levels(df_$label_color))+
    scale_x_discrete(limits=c("2015 - 2016\nGeplant","2017\nGeplant","2017\nAngeboten"))+
    geom_text(aes(label=ifelse(tot>4,tot, "")), size = 8, position = position_stack(vjust = 0.5))+ 
    annotate("text",x=1:3,y=500,label=c(text$label2[1],text$label2[1],text$label2[2]), size=8)+
    mytheme
```

Die Abbildung \ref{fig:fig3} zeigt f?r die Herbstemester die kalkulierte Planung von 2015 und 2016 als auch das geplante Angebot des Experiments im HS 2017. Die dritte S?ule zeigt die tats?chlich angebotene Auswahl f?r das HS 2017.
Das geplante Angebot und das tats?chliche Angebot im HS 2017 unterscheiden sich in den Men?-Inhalten^[Fleisch oder Fisch, Vegetarisch, Vegan (authentisch) und Vegan (Fleischsubstitut)] nicht statisch (`r apa(chi_s)`). Auch beim n?heren Betrachten unterschieden sich die geplanten und tats?chlichen Angeboten f?r das HS 2017 in den Men?-Inhalten zwischen den Basis- (`r apa(chi_s2)`) und Interventionswochen (`r apa(chi_s3)`) nicht. 
\par
Wird das tats?chliche Angebot n?her beleuchtet, wurden in den Interventionenwochen (*n* = 238) 40 Prozent fleischhaltige, knapp einem Drittel vegetarische und 27 Prozent vegane Gerichte angeboten. In den 12 Basiswochen (*n* = `r 480-238`) entiehlten $\frac{2}{3}$ Prozent des Angebots Fleisch oder Fisch. Vegetarische Gerichte machten rund 29 Prozent und vegane Gerichte knapp ein Prozent aus. 
<!-- ?berpr?fe nochmals ob das so stimmt -->



#### 4.3 Einfluss Men?-Angebot
```{r, echo=F, results="hide", include=FALSE, message=F}
# calculate anova with interaction

df <- df_agg %>% group_by(condit, week, label_content) %>%
    summarise(tot = n())

aov1 <- aov(tot ~ condit*label_content, data = df)
summary(aov1)

autoplot(aov1) # dont see that bad

TukeyHSD(aov1, ordered = T)

```


Wird ein gr?sseres und vielf?ltigeres Angebot an attraktiven vegetarischen und veganen Gerichten von den Mensabesuchern h?ufiger gew?hlt? Es zeigten sich Unterschiede in den Verkaufszahlen zwischen den Versuchsbedingungen un den Men?-Inhalten. Post-hoc-Analysen (nach Tukey) zeigten, dass es keine statistischen Unterschiede in den Verkaufszahlen beim Hot and Cold und im vegetarischen Angebot zwischen den beiden Versuchsbedingungen "Basis" und "Intervention" gab. Auffallend sind die signifikanten Unterschiede im Verkauf von Fleischgerichten, welche deutlich seltener in den Interventionswochen als in den Basiswochen verkauft wurden. Dass sich mehr vegane Gerichte in den Interventionswochen gekauft wurden lag daran, dass es in den Basiswochen lediglich ein kleines veganes Angebot gab (siehe Abbildung \ref{fig:fig4}).



```{r, fig.cap="\\label{fig:fig4} Die Abbildung zeigt die verkauften Gerichten nach Men?-Inhalt und Bedingung (Intervention- und Basiswochen).", out.width='100%',  fig.height=10, fig.width=14}

# visualize findings from above
m_sell <- na.omit(sell_dat) %>% group_by(condit,label_content2) %>% summarise(val = mean(tot_sold)) # calculate means (per what) of the label_content per condition

ggplot(sell_dat, aes(x = condit, y = tot_sold, linetype = label_content2, shape = label_content2)) + 
    geom_point(data = m_sell, aes(y = val), size = 4) +
    geom_line(data = m_sell, aes(y = val, group = label_content2), size = 2) + 
    labs(y = "Durchschnittlich verkaufte Gerichte pro Woche", x = "Bedingungen") + 
    guides(shape = guide_legend(title = "Men?-Inhalt"), linetype = F)+
    scale_y_continuous(breaks = seq(0,1400,200), limits = c(0, 1400)) +
    mytheme
```


#### 4.4 Einfluss Men?-Linien

Sind die aktuellen Men?-Linien tats?chlich ein veraltetes Konzept? Nebst der ?nderung im Angebot, war eine weitere Intervention die Gerichte ?ber neutrale Men?-Gef?sse sog. Men?-Linien zu vertreiben. F?r das Experiment wurde die Men?-Linie Green zu World unbenannt, damit die Men?-Inhalte randomisiert ?ber diese drei Men?-Linien angeboten werden konnten. Die Abbildung \ref{fig:fig5} vergleicht die Verkaufszahlen gemessen an den Men?-Linien der Jahren 2015, 2016 und 2017.

```{r, fig.cap="\\label{fig:fig5} Die Abbildung zeigt die verkauften Gerichten nach Men?-Linien im Vergleich (2015, 2016 und 2017).", fig.height=8, fig.width=14}

# prepare data
df <- menu_tot %>%
    group_by(article_description, year) %>%
    summarise(tot_sold = sum(tot_sold))

# change first some strings
df$article_description[grep("Local+",df$article_description)] <- "Local" # summarize all locals
df$article_description[grep("Green",df$article_description)] <- "Green/World"
df$article_description[grep("World",df$article_description)] <- "Green/World"

# aggregate again because of locale

df <- df %>% group_by(article_description, year) %>%
    summarise(tot_sold = sum(tot_sold))

df <- df %>% # calculate percentage
    group_by(year) %>% mutate(pct = tot_sold/sum(tot_sold))


## check if the background color is dark or not
# see mytheme for function
# my colors for the plot
ColsPerCat=c("Local" = "black","Favorite"="#c5b87c", "Green/World" = "#fad60d", "Kitchen" = "#008099","Hot and Cold"="#4c4848")

df$label_color <- as.factor(sapply(unlist(ColsPerCat)[df$article_description], # takes every label and their belonged color
                                    function(color) { if (isDark(color)) 'white' else 'black' })) # check if color is dark, than give back "white" else "black"

# define annotation
text <- group_by(df, year) %>% summarise(tot=sum(tot_sold)) %>%
    mutate(tot2=format(tot, big.mark = "'", scientific = F)) %>% # add thousand seperator
    mutate(label = "n") %>%
    mutate(label2=paste(label,tot2,sep=" = "))

# plot data
ggplot(df, aes(y=tot_sold,x=as.factor(year), fill=factor(article_description,levels=c("Local","Kitchen","Green/World","Favorite","Hot and Cold")), color = label_color)) +
    geom_bar(stat="identity", position = "stack", color=NA, width = .6) +
    #ggtitle("Verkaufte Men?s: 3. + 4. HSW\n") +
    xlab("Herbstsemester (Kalenderwochen 40 bis 51)") +
    ylab("Verkaufte Men?s pro Herbstsemester")+
    guides(fill= guide_legend(title = "Men?-Linien"), 
           color=F)+
    scale_fill_manual(values = ColsPerCat,
                      breaks = attributes(ColsPerCat)$names,
                      labels = c("Local/Zusatzangebot","Kitchen","Green/World","Favorite","Hot and Cold"))+
    scale_color_manual(values = levels(df$label_color))+
    geom_text(aes(label=ifelse(pct*100>2,paste0(round(pct*100, digits=0),"%"),"")), size = 6, position = position_stack(vjust = 0.5))+ # omit 1% annotation
    annotate("text",x = 1:3, y = 27500, label = text$label2, size=6)+
    mytheme


```


Die Abbildung \ref {fig:fig5} zeigt, dass es zwischen den drei Herbstsemestern klare Unterschiede in den Verkauszahlen zwischen den Men?-Linien gab. Die Grafik zwar l?sst keine Schl?sse ?ber deren Men?-Inhalt zu, aber die randomisierte Ausgabe der Gerichte konnte aufzeigen, dass es einen Einfluss auf die Men?-Wahl genommen hat. So wurden beispielsweise auch vegetarischen Gerichte auf der teureren Men?-Linie ?Kitchen? problemlos von den G?sten gekauft.

\newpage

###	5. Diskussion

Nach unserem Wissen wurde noch kein Real-Labor-Experiment durchgef?hrt, welches die Reaktion der G?ste auf ein ressourcenschonenderes Angebot aufzeichnete. Es gibt einige Untersuchungen wobei mittels Experimenten getestet wurde wie die Mensag?ste auf bestimmte Labels (z. B. zu gesunder Ern?hrung oder umweltfreundlichen Gerichten) [@hoefkens_what_2012; @spaargaren_consumer_2013; @thorndike_2-phase_2012], auf Pr?sentationen oder Positionierung von Nahrungsmitteln [@wansink_slim_2013; @van_kleef_healthy_2012; @Bucher el at.] oder auf soziale oder injuktive Normen [@collins_two_2019] reagierten.
\par
Zusammengefasst zeigen die Ergebnisse dieser Studie, dass eine Erh?hung des vegetarischen und veganen Angebots in Kombination mit neutralen Men?-Lienien und einer randomisierten Ausgabe des Men?-Inahlts zu einer Senkung des Fleischkonsums f?hren k?nnten.  
Eine m?gliche Erkl?rung f?r die Senkung des Fleischkonsums ist die Erh?hung der Verf?gbarkeit der vegetarischen und veganen Gerichten. Gem?ss fr?heren Studien [siehe @blanchette_determinants_2005; @neumark-sztainer_factors_1999; @van_kleef_exploiting_2015] f?hrt eine h?here Verf?gbarkeit, z. B. von gesundem Essen, auch zu einem Einfluss auf das Ern?hrungsverhalten. Ensaff und Kollegen [-@ensaff_food_2015] konnten in ihrer Studie aufzeigen, dass die Verf?gbarkeit als Nudging-Strategie eine Ver?nderung im Kaufverhalten von pflanzenbasierten Nahrungsmitteln hervorgerufen hat. Ein weiterer Einflussfaktor k?nnte das vergr?sserte Angebot, welches durch das Caternig Unternehmen generiert wurde, darstellen. Denn Aschemann-Witzel und Kollegen [-@aschemann-witzel_effects_2013] fanden in ihrer Studie heraus, dass eine Erh?hung der Auswahlmenge einen Einfluss auf das gesunde Wahlverhalten nimmt.
\par
In den Interventionswochen liessen sich die veganen authentische Gerichte besser verkauften als die veganen Gerichte mit Fleischsubstituten. Dieses Ergebnis unserer Studie geht im Einklang mit Ergebnis fr?herer Studien, welche zeigten, dass die Akzeptanz von Fleischsubstituten immernoch relativ klein ist [siehe @hoek_will_2010; @de_boer_merits_2011]. Zudem fanden Elzerman und Kollegen [-@elzerman_consumer_2011] heraus, dass der Gerichte-Kontext (z. B. Ingredienzen) einen starken Einfluss auf den Konsum von Fleischsubstituten nimmt. 
\par
Obwohl die Men?-Linien resp. Men?-Labels oftmals f?r die G?stef?hrung eingef?hrt werden, konnte im Experiment aufgezeigt werden, dass durch die Wahl von neutralen Men?-Linien und eine randomisierte Ausgabe der Gerichte auch teurere vegetarische und vegane Gerichte von den Mensabesucher gekauft werden. Auch in der Literatur wird kontrovers disskutiert, ob Labels ?berhaupt einen Einfluss auf die Men?-Wahl nehmen [siehe @spaargaren_consumer_2013; @kiszko_influence_2014; @aschemann-witzel_effects_2013].
\par
Ob nun die randomisierte Ausgabe, die neutralen Men?-Linien, die quantitative Erh?hung von vegetarische und vegane Gerichten oder die Kombination dieser Interventionen f?r die Senkung des Fleischkonsums zust?ndig ist, bedarf es an weiteren Untersuchungen. Weiter konnte in diesem Experiment die qualitative Gleichwertigkeit der t?glich angebotenen Gerichte nicht ?berpr?ft werden, was gegebenenfalls bei dem Kauf eines Gerichts einen Einfluss nehmen k?nnte [siehe @myung 2008]. Zudem basieren die gezeigten Ergebnisse lediglich auf aggregierte Verkaufszahlen, was keine Schl?sse auf kausale Zusammenh?nge zulassen.
\par
Eine Kaufentscheidung zu verstehen und demnach zu beeinflussen ist sehr komplex, denn wir f?llen ?ber 200 Essensentscheide pro Tag [@wansink_mindless_2007]. Es zeigt sich aber immer mehr, dass die meisten Entscheide anhand einfachen Heuristiken sog. Faustregeln gef?llt werden [siehe @scheibehenne_fast_2007]. Inwiefern die Intervention auch tats?chlich einen Einfluss auf das individuelle Wahlverhalten nimmt, wird in einem separaten Kurzbericht thematisiert (siehe Egeler & Baur, 2018b). 

###	6. Schlussfolgerungen

Eine Erh?hung von Anzahl und Anteil an vegetarischen und veganen Gerichten in Kombination mit neutralen Men?-Linien und randomisierter Ausgabe der drei Men?-Inhalten (Fleisch oder Fisch, vegetarisch und vegan), scheint den Konsum von Fleischgerichten zu reduzieren. An diesem Punkt ist es wichtig zu erw?hnen, dass die vegetarischen und veganen Gerichte diskret neben anderen Inhaltsstoffen deklariert und nicht angepriesen wurden. Ziel war es mit diesen Interventionen den Gast vermehrt dazu f?hren, sich mit dem Men?-Inhalt auseinanderzusetzten, alte Gewohnheiten fallen zu lassen und die Neophobie zu verkleinern.
\par
Wenn es um den einzelnen Verkauf von veganen Gerichten geht, scheinen authentische Gerichte besser als Gerichte mit Fleischsubstitute abzuschneiden. Daher nicht nur Fleischsubstitute anbieten und wenn Fleischsubstitute angeboten werden, sollte auf den Men?-Kontext geachten werden. Zudem zeigte sich, dass auch vegetarische und vegane Gerichte auf der teureren Men?-Linie "Kitchen" ebenfalls von den G?sten akzeptiert und gekauft wurden. 
\par
In diesem Experiment konnte die qualitative Gleichwertigkeit der angebotenen Gerichte nicht ber?cksichtigt werden. Bei einem weiteren Mensa-Experiment sollte die Gleichwertigkeit der Gerichte bei der Angebotsentwicklung mittels Fachleuten oder Koch-Experten ber?cksichtigt werden.
\par
Mit diesem Experiment konnte gezeigt werden, dass sich die Verkaufszahlen ?ber die Zeit durch eine Erh?hung des vegetarischen und veganen Angebots nicht zur?ckgegangen sind. Das spezielle Setting und die spezielle Stichprobe haben bestimmt daf?r beigetragen, nichtsdestotrotz w?ren weitere Pilotstudien an anderen Kantinen w?nschenswert.

Weitere Informationen zum Projekt k?nnen auf unserer [Webpage](novanimal.ch) gefunden werden. 

###	7. Danksagung

Wir bedanken uns bei der SV Schweiz und insbesondere bei den konkreten Verantwortlichen (Area- und Restaurantmanager und K?chenteam) f?r die hilfsbereite und unkomplizierte Unterst?tzung (Lieferung von Daten, Rezepturen, Beantwortung von Fragen).

### 8. Hinweise des Autors

Dieser Bericht mit allen Berechnungen sind auf [github](https://github.com/GAEgeler/tilldata_2017) verf?gbar.

### 9. Quellen